
#include "bitmap.h"
#include "cmod.h"
#include "darray.h"
#include "file.h"
#include "fsfont.h"
#include "memory.h"
#ifdef CMOD_SERIALIZED
#include "serialized.h"
#endif
#include "stdfunc.h"
#include "string.h"

#define FSFONT_SPACEWIDTH 3

/*--------------------------------------------------------------------------*/

void FSFont_Init(FSFont *fsfont, FSFont *fsfont_org) {

	if (fsfont_org == NULL) {
		fsfont->startchar = 0;
		fsfont->glyph = DArray_Create(64);
		fsfont->width = 0;
		fsfont->height = 0;
		fsfont->baseline = 0;
	} else {
		fsfont->startchar = fsfont_org->startchar;
		fsfont->glyph = DArray_Clone(fsfont_org->glyph, (CloneFunc *)BitMap_Clone);
		fsfont->width = fsfont_org->width;
		fsfont->height = fsfont_org->height;
		fsfont->baseline = fsfont_org->baseline;
	}
}

/*--------------------------------------------------------------------------*/

FSFont *FSFont_Create(void) {
	FSFont *fsfont;

	fsfont = Memory_Reserve(1, FSFont);
	FSFont_Init(fsfont, NULL);

	return fsfont;
}

/*--------------------------------------------------------------------------*/

FSFont *FSFont_Clone(FSFont *fsfont) {
	FSFont *fsfont2;

	fsfont2 = Memory_Reserve(1, FSFont);
	FSFont_Init(fsfont2, fsfont);

	return fsfont2;
}

/*--------------------------------------------------------------------------*/
//#define FSFONT_DUMPFONT 
FSFont *FSFont_ReadBDFFile(String *filename) {
   BitMap *bm;
   String *row;
   String command[256];
   File *f;
   int i, x, y, nof, current;
   int bbxw, bbxh, bbxx, bbxy;
   unsigned int dc;
   FSFont *fsfont;
//   int mode; /* 0 = misc, 1 = properties, 2 = char bitmap data */
   Bool started = FALSE;
   String *data;
   PixelColor w;
   PixelColor b;
   
   f = File_Open(filename, "r");
   if (f == NULL) return NULL;
   
   w = PixelColor_FromRGB(255,255,255);
   w.a = 1;
   b = PixelColor_FromRGB(0,0,0);
   b.a = 255;
   current = 0;
   fsfont = FSFont_Create();
   
   while (!File_Eof(f) && current<256) {
//   while (!File_Eof(f)) {
      row = File_ReadLine(f);
      i = 0;
      while (row[i] != ' ' && row[i] != '\n' && row[i] != 0 && i<255) {
         command[i] = row[i];
         i++;
      }
      command[i] = 0;
      
      if (String_IsEqual(command, "FONTBOUNDINGBOX")) {
         sscanf(&row[i], " %i %i", &fsfont->width, &fsfont->height);
      } else
      if (String_IsEqual(command, "FONT_DESCENT")) {
         sscanf(&row[i], " %i", &fsfont->baseline);
      } else
      if (String_IsEqual(command, "ENCODING")) {
         sscanf(&row[i], " %i", &nof);
      } else
      if (String_IsEqual(command, "BBX")) {
         sscanf(&row[i], " %i %i %i %i", &bbxw, &bbxh, &bbxx, &bbxy);
#ifdef FSFONT_DUMPFONT 
         printf("/* %02X (%c) */ 0x%02X",nof,nof,(unsigned int)((fsfont->height-1-bbxy)) | (fsfont->height-bbxy-bbxh << 4));
#endif
//         printf("%02X: x width=%i rows=%i-%i {",nof,bbxw,bbxy,bbxy+bbxh);
         bbxy = (fsfont->height - fsfont->baseline) - bbxy - bbxh;
//         bbxy = fsfont->height - bbxy - bbxh;
//         bbxx = fsfont->width - bbxx;
      } else
      if (String_IsEqual(command, "STARTCHAR")) {
         bbxx = 0; 
         bbxy = 0;
         bbxw = fsfont->width;
         bbxh = fsfont->height;
         if (!started) {
            if (String_IsEqual(&row[i+1],  "space") || String_IsEqual(&row[i+1],  "char32")) {
               started = TRUE;
               current = ' ';
               fsfont->startchar = current;
            }
         }
         nof = current;
      } else
      if (String_IsEqual(command, "BITMAP") && started && nof < 256) {
         bm = BitMap_Create(fsfont->width, fsfont->height);
         BitMap_FillRect(bm, 0, 0, fsfont->width+1, fsfont->height+1, b);
//         printf("char %i ---------------------\n", nof);

   		if (current == 0xd0) printf("Here for %s!\n", filename);
//         printf("Character %02x\n", nof);
         for (y=bbxy; y<bbxh+bbxy; y++) {
//            String bah[17] = { 0 };
            data = File_ReadLine(f);
            sscanf(data, "%x\n", &dc);
#ifdef FSFONT_DUMPFONT 
            printf(", 0x%02x", dc);
#endif
            if (String_Length(data) < 4) dc<<=8;
//            printf("%04x ", dc);
            for (x=bbxx; x<bbxx+bbxw; x++) {
               if (dc & (unsigned int)0x8000) {
//                 bah[x] = '#';
                  BitMap_SetPixel(bm,x,y,w);
               } else {
//                  bah[x] = ' ';
                  BitMap_SetPixel(bm,x,y,b);
               }
               
//               printf("%i", (dc & (unsigned int)0x8000)>0);
               dc*=2;
            }  
//            printf("%s\n", bah);        
            dc = 0;  
//          printf("\n");
            String_Destroy(data);
         }
//         printf("Stored as %02X\n\n", nof - fsfont->startchar);
//         DArray_Add(fsfont->glyph, bm);
//   		if (nof == 95) printf("%i\n", nof - fsfont->startchar);
   		if (nof - fsfont->startchar >= 0) DArray_SetElem(fsfont->glyph, nof - fsfont->startchar, bm); 
         else BitMap_Destroy(bm);
//         if (nof == 95) printf("%i\n", BitMap_SizeX(FSFont_Glyph(fsfont, '_')));
#ifdef FSFONT_DUMPFONT 
         printf(",\n");
#endif
         current++;
      }
      String_Destroy(row);
   }
   File_Close(f);
   return fsfont;
   
//   return NULL;
}

/*--------------------------------------------------------------------------*/
#ifdef CMOD_SERIALIZED
void FSFont_Serialize(FSFont *fsfont, Serialized *ser) {
	Serialized_AppendWrapped(ser, &fsfont->startchar, sizeof(fsfont->startchar));
	DArray_Serialize(fsfont->glyph, ser, (SerializeFunc *)BitMap_Serialize);
	Serialized_AppendWrapped(ser, &fsfont->width, sizeof(fsfont->width));
	Serialized_AppendWrapped(ser, &fsfont->height, sizeof(fsfont->height));
	Serialized_AppendWrapped(ser, &fsfont->baseline, sizeof(fsfont->baseline));
}

/*--------------------------------------------------------------------------*/

FSFont *FSFont_DeSerialize(Serialized *ser) {
	FSFont *fsfont;
	fsfont = Memory_Reserve(1, FSFont);
	Serialized_ReadWrapped(ser, &fsfont->startchar, sizeof(fsfont->startchar));
	fsfont->glyph = DArray_DeSerialize(ser, (Func)BitMap_DeSerialize);
	Serialized_ReadWrapped(ser, &fsfont->width, sizeof(fsfont->width));
	Serialized_ReadWrapped(ser, &fsfont->height, sizeof(fsfont->height));
	Serialized_ReadWrapped(ser, &fsfont->baseline, sizeof(fsfont->baseline));
	return fsfont;
}
#endif
/*--------------------------------------------------------------------------*/

BitMap *FSFont_Glyph(FSFont *fsfont, int encoding) {
   if (encoding < 0) encoding += 256;
   if ((unsigned)encoding-fsfont->startchar < DArray_NofElems(fsfont->glyph))
   return (BitMap *)DArray_Elem(fsfont->glyph, encoding-fsfont->startchar);
   else return NULL;
}

/*--------------------------------------------------------------------------*/

void FSFont_PutText(FSFont *fsfont, BitMap *bm, int x, int y, const String *text, PixelColor color) {
   int i, xorg=x;
   BitMap *glyph;
   
   i = 0;
   
   while(text[i]!=0) {
      if (text[i] == '\n') {
         x = xorg;
         y += FSFont_Height(fsfont);         
      } 
      glyph = FSFont_Glyph(fsfont, text[i]);
      if (glyph != NULL) {	
         BitMap_PutBitMapRecolour(bm, glyph, x, y, color);
         x+=BitMap_SizeX(glyph);
      } else x+=FSFONT_SPACEWIDTH;
      i++;
   }
}

/*--------------------------------------------------------------------------*/

void FSFont_PutTextBG(FSFont *fsfont, BitMap *bm, int x, int y, const String *text, PixelColor color, PixelColor bg) {
   BitMap_FillRect(bm, x, y, x+String_Length(text)*fsfont->width, y+fsfont->height, bg);
   FSFont_PutText(fsfont, bm, x, y, text, color);
}

/*--------------------------------------------------------------------------*/

int FSFont_TextWidth(FSFont *f, const String *text) {
   int i,l=0,n;
   BitMap *g;
   if (text!=NULL) {
      n = String_Length(text);
      for (i=0; i<n; i++) {
//         printf("%02x ",text[i]); fflush(stdout);
         g = FSFont_Glyph(f, text[i]);         
         if (g!=NULL) l+=BitMap_SizeX(g); else l+=FSFONT_SPACEWIDTH;
      }
   }
   return l;
//   return FSFont_Width(f)*String_Length(text);
}

/*--------------------------------------------------------------------------*/

void FSFont_PutTextCenter(FSFont *fsfont, BitMap *bm, int x, int y, const String *text, PixelColor color) {
   int w = FSFont_TextWidth(fsfont, text);
   FSFont_PutText(fsfont, bm, x - (w/2), y-fsfont->height/2, text, color);
}

/*--------------------------------------------------------------------------*/

void FSFont_PutTextRightAligned(FSFont *fsfont, BitMap *bm, int x, int y, const String *text, PixelColor color) {
   int w = FSFont_TextWidth(fsfont, text);
   FSFont_PutText(fsfont, bm, x - w, y, text, color);
}

/*--------------------------------------------------------------------------*/

void FSFont_PutThickText(FSFont *fsfont, BitMap *bm, int x, int y, const String *text, PixelColor color, int thickness) {
   int i;
   for (i=0; i<thickness; i++) {
      FSFont_PutText(fsfont, bm, x+i, y, text, color);
   }
}

/*--------------------------------------------------------------------------*/

void    FSFont_PutThickTextCenter(FSFont *fsfont, BitMap *bm, int x, int y, const String *text, PixelColor color, int thickness) {
   int i;
   for (i=0; i<thickness; i++) {
      FSFont_PutTextCenter(fsfont, bm, x+i, y, text, color);
   }
}

/*--------------------------------------------------------------------------*/

void    FSFont_PutThickTextRightAligned(FSFont *fsfont, BitMap *bm, int x, int y, const String *text, PixelColor color, int thickness) {
   int i;
   for (i=0; i<thickness; i++) {
      FSFont_PutTextRightAligned(fsfont, bm, x-i, y, text, color);
   }
}

/*--------------------------------------------------------------------------*/

void FSFont_SetGlyph(FSFont *f, BitMap *glyph, int id) {
   BitMap *p;
   p = FSFont_Character(f, id);
   if (p != NULL) BitMap_Destroy(p);
   p = BitMap_CreateStretched(glyph, f->width, f->height);
   DArray_SetElem(f->glyph, id-f->startchar, p);   
}

/*--------------------------------------------------------------------------*/

void FSFont_Restore(FSFont *fsfont) {
	DArray_Destroy(fsfont->glyph, (DestFunc *)BitMap_Destroy);
}

/*--------------------------------------------------------------------------*/

void FSFont_Destroy(FSFont *fsfont) {
	FSFont_Restore(fsfont);
	Memory_Free(fsfont, FSFont);
}

/*--------------------------------------------------------------------------*/

unsigned char fsfont_embedded8x16[] = {
/* 10 (fwd)  0x2C, 0x40, 0x60, 0x70, 0x78, 0x7c, 0x7e, 0x7c, 0x78, 0x70, 0x60, 0x40,*/
/* 11 (bck)  0x1D, 0x01, 0x03, 0x07, 0x0f, 0x1f, 0x3f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x01, */
/* 11 (bck)  0x2C, 0x02, 0x06, 0x0e, 0x1e, 0x3e, 0x7e, 0x3e, 0x1e, 0x0e, 0x06, 0x02,*/
/* 10 (fwd) */ 0x1D, 0x40, 0x60, 0x70, 0x78, 0x7c, 0x7e, 0x7f, 0x7e, 0x7c, 0x78, 0x70, 0x60, 0x40,
/* 11 (bck) */ 0x1D, 0x02, 0x06, 0x0e, 0x1e, 0x3e, 0x7e, 0xfe, 0x7e, 0x3e, 0x1e, 0x0e, 0x06, 0x02, 
/* 12 (updn)*/ 0x1C, 0x18, 0x3c, 0x7e, 0xff, 0x3c, 0x3c, 0x3c, 0x3c, 0xff, 0x7e, 0x3c, 0x18,
/* 21 (!) */ 0x1C, 0x60, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0x60, 0x60, 0x60, 0x00, 0x60, 0x60,
/* 22 (") */ 0x03, 0xcc, 0xcc, 0x88, 0x44,
/* 23 (#) */ 0x3C, 0x66, 0x66, 0xff, 0xff, 0x66, 0x66, 0xff, 0xff, 0x66, 0x66,
/* 24 ($) */ 0x0D, 0x18, 0x7e, 0xff, 0xdb, 0xdb, 0x78, 0x78, 0x1e, 0x1e, 0xdb, 0xdb, 0xff, 0x7e, 0x18,
/* 25 (%) */ 0x0C, 0x70, 0xdb, 0xdb, 0x76, 0x0c, 0x0c, 0x18, 0x30, 0x30, 0x6e, 0xdb, 0xdb, 0x0e,
/* 26 (&) */ 0x1C, 0x3c, 0x7e, 0x66, 0x66, 0x3c, 0x78, 0x6d, 0xcf, 0xc7, 0xe6, 0x7f, 0x3b,
/* 27 (') */ 0x03, 0xc0, 0xc0, 0x40, 0x80,
/* 28 (() */ 0x0D, 0x18, 0x30, 0x60, 0x60, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x60, 0x60, 0x30, 0x18,
/* 29 ()) */ 0x0D, 0xc0, 0x60, 0x30, 0x30, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x30, 0x30, 0x60, 0xc0,
/* 2A (*) */ 0x4D, 0x18, 0x18, 0xdb, 0xff, 0x7e, 0x7e, 0xff, 0xdb, 0x18, 0x18,
/* 2B (+) */ 0x5C, 0x30, 0x30, 0x30, 0xfc, 0xfc, 0x30, 0x30, 0x30,
/* 2C (,) */ 0xBE, 0xc0, 0xc0, 0x40, 0x80,
/* 2D (-) */ 0x89, 0xfe, 0xfe,
/* 2E (.) */ 0xBC, 0xc0, 0xc0,
/* 2F (/) */ 0x2D, 0x06, 0x06, 0x0c, 0x0c, 0x18, 0x18, 0x30, 0x30, 0x60, 0x60, 0xc0, 0xc0,
/* 30 (0) */ 0x1C, 0x38, 0x7c, 0x6c, 0xee, 0xc6, 0xd6, 0xd6, 0xc6, 0xee, 0x6c, 0x7c, 0x38,
/* 31 (1) */ 0x1C, 0x60, 0x60, 0xe0, 0xe0, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
/* 32 (2) */ 0x1C, 0x3c, 0xfe, 0xc7, 0x03, 0x07, 0x0e, 0x3e, 0x78, 0xe0, 0xc0, 0xff, 0xff,
/* 33 (3) */ 0x1C, 0xff, 0xff, 0x06, 0x0c, 0x1c, 0x1e, 0x07, 0x03, 0xc3, 0xe7, 0x7e, 0x3c,
/* 34 (4) */ 0x1C, 0x0e, 0x0e, 0x1e, 0x1e, 0x36, 0x36, 0x66, 0x66, 0xff, 0xff, 0x06, 0x06,
/* 35 (5) */ 0x1C, 0xfe, 0xfe, 0xc0, 0xc0, 0xf8, 0xfe, 0x06, 0x03, 0x03, 0xc6, 0xfe, 0x38,
/* 36 (6) */ 0x1C, 0x3c, 0x7e, 0x62, 0xc0, 0xd8, 0xfe, 0xe6, 0xc3, 0xc3, 0x66, 0x7e, 0x3c,
/* 37 (7) */ 0x1C, 0xff, 0xff, 0x06, 0x0e, 0x0c, 0x1c, 0x18, 0x38, 0x30, 0x70, 0x60, 0x60,
/* 38 (8) */ 0x1C, 0x3c, 0x7e, 0x66, 0x66, 0x3c, 0x7e, 0xe7, 0xc3, 0xc3, 0xe7, 0x7e, 0x3c,
/* 39 (9) */ 0x1C, 0x3c, 0x7e, 0xe7, 0xc3, 0xc3, 0xe7, 0x7f, 0x3b, 0x03, 0x66, 0x7e, 0x3c,
/* 3A (:) */ 0x5B, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0xc0, 0xc0,
/* 3B (;) */ 0x5D, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0x40, 0x80,
/* 3C (<) */ 0x2C, 0x06, 0x0e, 0x1c, 0x38, 0x70, 0xe0, 0x70, 0x38, 0x1c, 0x0e, 0x06,
/* 3D (=) */ 0x6B, 0xfe, 0xfe, 0x00, 0x00, 0xfe, 0xfe,
/* 3E (>) */ 0x2C, 0xc0, 0xe0, 0x70, 0x38, 0x1c, 0x0e, 0x1c, 0x38, 0x70, 0xe0, 0xc0,
/* 3F (?) */ 0x1C, 0x7c, 0xfe, 0xc6, 0xc6, 0x0e, 0x0c, 0x1c, 0x18, 0x18, 0x00, 0x18, 0x18,
/* 40 (@) */ 0x2C, 0x1c, 0x76, 0x43, 0xdd, 0xb5, 0xa5, 0xb5, 0xdf, 0x40, 0x76, 0x1c,
/* 41 (A) */ 0x1C, 0x18, 0x18, 0x18, 0x3c, 0x3c, 0x3c, 0x66, 0x66, 0x7e, 0xff, 0xc3, 0xc3,
/* 42 (B) */ 0x1C, 0xfc, 0xfe, 0xc6, 0xc6, 0xc6, 0xfc, 0xfc, 0xc6, 0xc6, 0xc6, 0xfe, 0xfc,
/* 43 (C) */ 0x1C, 0x3e, 0x7f, 0x63, 0xc1, 0xc0, 0xc0, 0xc0, 0xc0, 0xc1, 0x63, 0x7f, 0x3e,
/* 44 (D) */ 0x1C, 0xf8, 0xfe, 0xc6, 0xc7, 0xc3, 0xc3, 0xc3, 0xc3, 0xc7, 0xc6, 0xfe, 0xf8,
/* 45 (E) */ 0x1C, 0xff, 0xff, 0xc0, 0xc0, 0xc0, 0xfc, 0xfc, 0xc0, 0xc0, 0xc0, 0xff, 0xff,
/* 46 (F) */ 0x1C, 0xff, 0xff, 0xc0, 0xc0, 0xc0, 0xfc, 0xfc, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,
/* 47 (G) */ 0x1C, 0x3e, 0x7f, 0x63, 0xc1, 0xc0, 0xc0, 0xcf, 0xcf, 0xc3, 0x67, 0x7f, 0x3d,
/* 48 (H) */ 0x1C, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xff, 0xff, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3,
/* 49 (I) */ 0x1C, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,
/* 4A (J) */ 0x1C, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x86, 0xcc, 0xfc, 0x78,
/* 4B (K) */ 0x1C, 0xc3, 0xc7, 0xce, 0xdc, 0xf8, 0xf0, 0xf0, 0xf8, 0xdc, 0xce, 0xc7, 0xc3,
/* 4C (L) */ 0x1C, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xff, 0xff,
/* 4D (M) */ 0x1C, 0xc3, 0xc3, 0xe7, 0xe7, 0xff, 0xff, 0xff, 0xdb, 0xdb, 0xc3, 0xc3, 0xc3,
/* 4E (N) */ 0x1C, 0xc6, 0xc6, 0xe6, 0xe6, 0xf6, 0xf6, 0xde, 0xde, 0xce, 0xce, 0xc6, 0xc6,
/* 4F (O) */ 0x1C, 0x3c, 0x7e, 0x66, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0x66, 0x7e, 0x3c,
/* 50 (P) */ 0x1C, 0xf8, 0xfe, 0xc6, 0xc3, 0xc3, 0xc3, 0xc6, 0xfe, 0xf8, 0xc0, 0xc0, 0xc0,
/* 51 (Q) */ 0x1D, 0x3c, 0x7e, 0x66, 0xc3, 0xc3, 0xc3, 0xc3, 0xdb, 0xdf, 0x6e, 0x7f, 0x3f, 0x01,
/* 52 (R) */ 0x1C, 0xf8, 0xfe, 0xc6, 0xc3, 0xc3, 0xc3, 0xc6, 0xfe, 0xfc, 0xce, 0xc7, 0xc3,
/* 53 (S) */ 0x1C, 0x18, 0x7e, 0x66, 0xc0, 0x60, 0x78, 0x1e, 0x06, 0x03, 0xc6, 0xfe, 0x38,
/* 54 (T) */ 0x1C, 0xff, 0xff, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
/* 55 (U) */ 0x1C, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0x66, 0x7e, 0x3c,
/* 56 (V) */ 0x1C, 0xc3, 0xc3, 0xc3, 0x66, 0x66, 0x66, 0x3c, 0x3c, 0x3c, 0x18, 0x18, 0x18,
/* 57 (W) */ 0x1C, 0xc3, 0xc3, 0xc3, 0xc3, 0xdb, 0xdb, 0xdb, 0xff, 0xff, 0x66, 0x66, 0x66,
/* 58 (X) */ 0x1C, 0xc6, 0xc6, 0x6c, 0x6c, 0x38, 0x38, 0x38, 0x38, 0x6c, 0x6c, 0xc6, 0xc6,
/* 59 (Y) */ 0x1C, 0xc3, 0xc3, 0xc3, 0xe7, 0x66, 0x7e, 0x3c, 0x18, 0x18, 0x18, 0x18, 0x18,
/* 5A (Z) */ 0x1C, 0xfe, 0xfe, 0x0c, 0x0c, 0x18, 0x18, 0x30, 0x30, 0x60, 0x60, 0xfe, 0xfe,
/* 5B ([) */ 0x0D, 0xf0, 0xf0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xf0, 0xf0,
/* 5C (\) */ 0x1C, 0xc0, 0xc0, 0x60, 0x60, 0x30, 0x30, 0x18, 0x18, 0x0c, 0x0c, 0x06, 0x06,
/* 5D (]) */ 0x0D, 0xf0, 0xf0, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0xf0, 0xf0,
/* 5E (^) */ 0x18, 0x18, 0x18, 0x3c, 0x3c, 0x66, 0x66, 0xc3, 0xc3,
/* 5F (_) */ 0xEF, 0xff, 0xff,
/* 60 (`) */ 0x03, 0xc0, 0xc0, 0x80, 0x40,
/* 61 (a) */ 0x5C, 0x7c, 0xfe, 0x06, 0x7e, 0xfe, 0xc6, 0xfe, 0x76,
/* 62 (b) */ 0x1C, 0xc0, 0xc0, 0xc0, 0xc0, 0xdc, 0xfe, 0xc6, 0xc6, 0xc6, 0xe6, 0xfe, 0xdc,
/* 63 (c) */ 0x5C, 0x3c, 0x7e, 0xe6, 0xc0, 0xc0, 0xe6, 0x7e, 0x3c,
/* 64 (d) */ 0x1C, 0x06, 0x06, 0x06, 0x06, 0x76, 0xfe, 0xc6, 0xc6, 0xc6, 0xce, 0xfe, 0x76,
/* 65 (e) */ 0x5C, 0x7c, 0xfe, 0xc6, 0xfe, 0xfe, 0xc0, 0xfe, 0x7c,
/* 66 (f) */ 0x1C, 0x30, 0x70, 0x60, 0x60, 0xf0, 0xf0, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
/* 67 (g) */ 0x5F, 0x76, 0xfe, 0xce, 0xc6, 0xc6, 0xce, 0xfe, 0x76, 0x06, 0xfe, 0x7c,
/* 68 (h) */ 0x1C, 0xc0, 0xc0, 0xc0, 0xc0, 0xdc, 0xfe, 0xe6, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6,
/* 69 (i) */ 0x2C, 0xc0, 0xc0, 0x00, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,
/* 6A (j) */ 0x2F, 0x60, 0x60, 0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0xe0, 0xc0,
/* 6B (k) */ 0x1C, 0xc0, 0xc0, 0xc0, 0xc0, 0xc6, 0xce, 0xdc, 0xf8, 0xf8, 0xdc, 0xce, 0xc6,
/* 6C (l) */ 0x1C, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,
/* 6D (m) */ 0x5C, 0xfe, 0xff, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb,
/* 6E (n) */ 0x5C, 0xdc, 0xfe, 0xe6, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6,
/* 6F (o) */ 0x5C, 0x3c, 0x7e, 0xe7, 0xc3, 0xc3, 0xe7, 0x7e, 0x3c,
/* 70 (p) */ 0x5F, 0xdc, 0xfe, 0xe6, 0xc6, 0xc6, 0xc6, 0xfe, 0xdc, 0xc0, 0xc0, 0xc0,
/* 71 (q) */ 0x5F, 0x76, 0xfe, 0xce, 0xc6, 0xc6, 0xc6, 0xfe, 0x76, 0x06, 0x06, 0x06,
/* 72 (r) */ 0x5C, 0xdc, 0xfe, 0xe6, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,
/* 73 (s) */ 0x5C, 0x7c, 0xfe, 0xc0, 0xfc, 0x7e, 0x06, 0xfe, 0x7c,
/* 74 (t) */ 0x3C, 0x60, 0x60, 0xf0, 0xf0, 0x60, 0x60, 0x60, 0x60, 0x70, 0x30,
/* 75 (u) */ 0x5C, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xce, 0xfe, 0x76,
/* 76 (v) */ 0x5C, 0xc3, 0xc3, 0x66, 0x66, 0x3c, 0x3c, 0x18, 0x18,
/* 77 (w) */ 0x5C, 0xc3, 0xc3, 0xdb, 0xdb, 0xdb, 0xff, 0x7e, 0x66,
/* 78 (x) */ 0x5C, 0xc3, 0xe7, 0x7e, 0x3c, 0x3c, 0x7e, 0xe7, 0xc3,
/* 79 (y) */ 0x5F, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xce, 0xfe, 0x76, 0x06, 0xfe, 0x7c,
/* 7A (z) */ 0x5C, 0xff, 0xff, 0x0e, 0x1c, 0x38, 0x70, 0xff, 0xff,
/* 7B ({) */ 0x0D, 0x30, 0x60, 0x60, 0x60, 0x60, 0x60, 0xc0, 0xc0, 0x60, 0x60, 0x60, 0x60, 0x60, 0x30,
/* 7C (|) */ 0x0F, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,
/* 7D (}) */ 0x0D, 0xc0, 0x60, 0x60, 0x60, 0x60, 0x60, 0x30, 0x30, 0x60, 0x60, 0x60, 0x60, 0x60, 0xc0,
/* 7E (~) */ 0x02, 0x71, 0xff, 0x8e,

/* C0 (À) */ 0x0C, 0x30, 0x18, 0x00, 0x10, 0x38, 0x38, 0x38, 0x6c, 0x6c, 0x7c, 0xfe, 0xc6, 0xc6,
/* C1 (Á) */ 0x0C, 0x18, 0x30, 0x00, 0x10, 0x38, 0x38, 0x38, 0x6c, 0x6c, 0x7c, 0xfe, 0xc6, 0xc6,
/* C2 (Â) */ 0x0C, 0x10, 0x38, 0x6c, 0x10, 0x38, 0x38, 0x38, 0x6c, 0x6c, 0x7c, 0xfe, 0xc6, 0xc6,
/* C3 (Ã) */ 0x0C, 0x32, 0x7e, 0x4c, 0x10, 0x38, 0x38, 0x38, 0x6c, 0x6c, 0x7c, 0xfe, 0xc6, 0xc6,
/* C4 (Ä) */ 0x0C, 0x66, 0x66, 0x18, 0x18, 0x3c, 0x3c, 0x3c, 0x66, 0x66, 0x7e, 0xff, 0xc3, 0xc3,
/* C5 (Å) */ 0x0C, 0x38, 0x6c, 0x38, 0x10, 0x38, 0x38, 0x38, 0x6c, 0x6c, 0x7c, 0xfe, 0xc6, 0xc6,
/* C6 (Æ) */ 0x1C, 0x1f, 0x1f, 0x1c, 0x3c, 0x3c, 0x3e, 0x7e, 0x6c, 0x6c, 0xcc, 0xcf, 0xcf,
/* C7 (Ç) */ 0x1F, 0x3c, 0x7e, 0x66, 0xc2, 0xc0, 0xc0, 0xc0, 0xc0, 0xc2, 0x66, 0x7e, 0x3c, 0x0c, 0x2c, 0x18,
/* C8 (È) */ 0x0C, 0x30, 0x18, 0x00, 0xfe, 0xfe, 0xc0, 0xc0, 0xf8, 0xf8, 0xc0, 0xc0, 0xfe, 0xfe,
/* C9 (É) */ 0x0C, 0x18, 0x30, 0x00, 0xfe, 0xfe, 0xc0, 0xc0, 0xf8, 0xf8, 0xc0, 0xc0, 0xfe, 0xfe,
/* CA (Ê) */ 0x0C, 0x10, 0x28, 0x00, 0xfe, 0xfe, 0xc0, 0xc0, 0xf8, 0xf8, 0xc0, 0xc0, 0xfe, 0xfe,
/* CB (Ë) */ 0x0C, 0x6c, 0x6c, 0x00, 0xfe, 0xfe, 0xc0, 0xc0, 0xf8, 0xf8, 0xc0, 0xc0, 0xfe, 0xfe,
/* CC (Ì) */ 0x0C, 0xc0, 0x60, 0x00, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,
/* CD (Í) */ 0x0C, 0x60, 0xc0, 0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
/* CE (Î) */ 0x0C, 0x60, 0x90, 0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
/* CF (Ï) */ 0x0C, 0xcc, 0xcc, 0x00, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
/* D0 (Ð) */ 0x4B, 0x03, 0x0f, 0x3f, 0xff, 0xff, 0x3f, 0x0f, 0x03,
/* D1 (Ñ) */ 0x0C, 0x34, 0x58, 0xc6, 0xc6, 0xe6, 0xe6, 0xf6, 0xd6, 0xde, 0xce, 0xce, 0xc6, 0xc6,
/* D2 (Ò) */ 0x0C, 0x30, 0x18, 0x00, 0x3c, 0x7e, 0x66, 0xc3, 0xc3, 0xc3, 0xc3, 0x66, 0x7e, 0x3c,
/* D3 (Ó) */ 0x0C, 0x0c, 0x18, 0x00, 0x3c, 0x7e, 0x66, 0xc3, 0xc3, 0xc3, 0xc3, 0x66, 0x7e, 0x3c,
/* D4 (Ô) */ 0x0C, 0x18, 0x3c, 0x66, 0x3c, 0x7e, 0x66, 0xc3, 0xc3, 0xc3, 0xc3, 0x66, 0x7e, 0x3c,
/* D5 (Õ) */ 0x0C, 0x7b, 0xde, 0x00, 0x3c, 0x7e, 0x66, 0xc3, 0xc3, 0xc3, 0xc3, 0x66, 0x7e, 0x3c,
/* D6 (Ö) */ 0x0C, 0x66, 0x66, 0x00, 0x3c, 0x7e, 0x66, 0xc3, 0xc3, 0xc3, 0xc3, 0x66, 0x7e, 0x3c,
/* D7 (×) */ 0x4B, 0x18, 0x18, 0x3c, 0x3c, 0x7e, 0x7e, 0xff, 0xff,
/* D8 (Ø) */ 0x0D, 0x06, 0x3e, 0x7e, 0x6e, 0xcf, 0xdb, 0xdb, 0xdb, 0xdb, 0xf3, 0x76, 0x7e, 0x7c, 0x60,
/* D9 (Ù) */ 0x0C, 0x30, 0x18, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0x66, 0x7e, 0x3c,
/* DA (Ú) */ 0x0C, 0x0c, 0x18, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0x66, 0x7e, 0x3c,
/* DB (Û) */ 0x0C, 0x18, 0x3c, 0x66, 0x00, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0x66, 0x7e, 0x3c,
/* DC (Ü) */ 0x0C, 0x66, 0x66, 0x00, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0x66, 0x7e, 0x3c,
/* DD (Ý) */ 0x0C, 0x0c, 0x18, 0xc3, 0xc3, 0xe7, 0x66, 0x7e, 0x3c, 0x18, 0x18, 0x18, 0x18, 0x18,
/* DE (Þ) */ 0x0F, 0xc0, 0xc0, 0xc0, 0xf8, 0xfe, 0xc6, 0xc3, 0xc3, 0xc3, 0xc3, 0xc6, 0xfe, 0xf8, 0xc0, 0xc0, 0xc0,
/* DF (ß) */ 0x1D, 0x7c, 0xfe, 0xc6, 0xc6, 0xc6, 0xfc, 0xfc, 0xc6, 0xc6, 0xc6, 0xde, 0xdc, 0xc0,
/* E0 (à) */ 0x2C, 0x30, 0x18, 0x00, 0x7c, 0xfe, 0x06, 0x7e, 0xfe, 0xc6, 0xfe, 0x76,
/* E1 (á) */ 0x2C, 0x18, 0x30, 0x00, 0x7c, 0xfe, 0x06, 0x7e, 0xfe, 0xc6, 0xfe, 0x76,
/* E2 (â) */ 0x1C, 0x18, 0x3c, 0x66, 0x00, 0x7c, 0xfe, 0x06, 0x7e, 0xfe, 0xc6, 0xfe, 0x76,
/* E3 (ã) */ 0x2C, 0x76, 0xdc, 0x00, 0x7c, 0xfe, 0x06, 0x7e, 0xfe, 0xc6, 0xfe, 0x76,
/* E4 (ä) */ 0x2C, 0x6c, 0x6c, 0x00, 0x7c, 0xfe, 0x06, 0x7e, 0xfe, 0xc6, 0xfe, 0x76,
/* E5 (å) */ 0x1C, 0x38, 0x6c, 0x38, 0x00, 0x7c, 0xfe, 0x06, 0x7e, 0xfe, 0xc6, 0xfe, 0x76,
/* E6 (æ) */ 0x5C, 0x7e, 0xff, 0x1b, 0x7f, 0xff, 0xdc, 0xff, 0x77,
/* E7 (ç) */ 0x5F, 0x3c, 0x7e, 0xe6, 0xc0, 0xc0, 0xe6, 0x7e, 0x3c, 0x18, 0x58, 0x30,
/* E8 (è) */ 0x2C, 0x30, 0x18, 0x00, 0x7c, 0xfe, 0xc6, 0xfe, 0xfe, 0xc0, 0xfe, 0x7c,
/* E9 (é) */ 0x2C, 0x18, 0x30, 0x00, 0x7c, 0xfe, 0xc6, 0xfe, 0xfe, 0xc0, 0xfe, 0x7c,
/* EA (ê) */ 0x1C, 0x10, 0x38, 0x6c, 0x00, 0x7c, 0xfe, 0xc6, 0xfe, 0xfe, 0xc0, 0xfe, 0x7c,
/* EB (ë) */ 0x2C, 0x6c, 0x6c, 0x00, 0x7c, 0xfe, 0xc6, 0xfe, 0xfe, 0xc0, 0xfe, 0x7c,
/* EC (ì) */ 0x2C, 0xc0, 0x60, 0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60,
/* ED (í) */ 0x1C, 0x40, 0xc0, 0x80, 0x00, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,
/* EE (î) */ 0x1C, 0x30, 0x78, 0xcc, 0x00, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
/* EF (ï) */ 0x2C, 0xcc, 0xcc, 0x00, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
/* F0 (ð) */ 0x4B, 0xc0, 0xf0, 0xfc, 0xff, 0xff, 0xfc, 0xf0, 0xc0,
/* F1 (ñ) */ 0x2C, 0x76, 0xdc, 0x00, 0xdc, 0xfe, 0xe6, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6,
/* F2 (ò) */ 0x2C, 0x30, 0x18, 0x00, 0x3c, 0x7e, 0xe7, 0xc3, 0xc3, 0xe7, 0x7e, 0x3c,
/* F3 (ó) */ 0x2C, 0x0c, 0x18, 0x00, 0x3c, 0x7e, 0xe7, 0xc3, 0xc3, 0xe7, 0x7e, 0x3c,
/* F4 (ô) */ 0x1C, 0x18, 0x3c, 0x66, 0x00, 0x3c, 0x7e, 0xe7, 0xc3, 0xc3, 0xe7, 0x7e, 0x3c,
/* F5 (õ) */ 0x2C, 0x7b, 0xde, 0x00, 0x3c, 0x7e, 0xe7, 0xc3, 0xc3, 0xe7, 0x7e, 0x3c,
/* F6 (ö) */ 0x2C, 0x66, 0x66, 0x00, 0x3c, 0x7e, 0xe7, 0xc3, 0xc3, 0xe7, 0x7e, 0x3c,
/* F7 (÷) */ 0x4B, 0xff, 0xff, 0x7e, 0x7e, 0x3c, 0x3c, 0x18, 0x18,
/* F8 (ø) */ 0x4D, 0x03, 0x3b, 0x7e, 0x6e, 0xdb, 0xdb, 0x76, 0x7e, 0xdc, 0xc0,
/* F9 (ù) */ 0x2C, 0x30, 0x18, 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xce, 0xfe, 0x76,
/* FA (ú) */ 0x2C, 0x18, 0x30, 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xce, 0xfe, 0x76,
/* FB (û) */ 0x1C, 0x10, 0x38, 0x6c, 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xce, 0xfe, 0x76,
/* FC (ü) */ 0x2C, 0x6c, 0x6c, 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xce, 0xfe, 0x76,
/* FD (ý) */ 0x2F, 0x18, 0x30, 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xce, 0xfe, 0x76, 0x06, 0xfe, 0x7c,
/* FE (þ) */ 0x1F, 0xc0, 0xc0, 0xc0, 0xc0, 0xfc, 0xfe, 0xc6, 0xc6, 0xc6, 0xfe, 0xfc, 0xc0, 0xc0, 0xc0, 0xc0,
/* FF (ÿ) */ 0x2F, 0x6c, 0x6c, 0x00, 0xc6, 0xc6, 0xc6, 0xc6, 0xc6, 0xce, 0xfe, 0x76, 0x06, 0xfe, 0x7c };

/* 0: nibble0: first row, nibble1: last row 
   n: bits in row n-1
*/
 
FSFont *FSFont_Default() {
   int encoding, x, y, w, firsty, lasty;
   unsigned char *beg, *cur;
   BitMap *bm;
   FSFont *fsfont = FSFont_Create();
   PixelColor black,white;
   
   white = PixelColor_FromRGB(255,255,255);
   white.a = 1;
   black = PixelColor_FromRGB(0,0,0);
   black.a = 255;
   fsfont->width = 8;
   fsfont->height = 16;
  
   cur = fsfont_embedded8x16;
   for (encoding = 0x10; encoding <= 0xff; encoding++) {
      if (encoding == 0x13) encoding = 0x21; else
      if (encoding == 0x7f) encoding = 0xc0;
      beg = cur;
      firsty = *cur >> 4;
      lasty = *cur & 0xf;
      w = 9;
      for (y=firsty; y<=lasty; y++) {
         x = Bit_Lowest(++cur, 8);
         if (x < w) w = x;
      }
/*    if (w > 5) w = 10 - w;
      else w = 9 - w;*/
      w = 9 - w;
      
      cur = beg+1;
      bm = BitMap_Create(w,fsfont->height);
      BitMap_FillRect(bm, 0, 0, w, fsfont->height, black);
      for (y=firsty; y<=lasty; y++) {
         for (x=0; x<8; x++) {
            if (*cur & std_bit[7-x]) BitMap_PutPixel(bm, x, y, white);
         }
         cur++;
      }
      DArray_SetElem(fsfont->glyph, encoding, bm);
   }
   return fsfont;
}

